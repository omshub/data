name: Crawl OSCAR Data

on:
  # Run every 30 minutes
  schedule:
    - cron: '*/30 * * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      mode:
        description: 'Which terms to fetch'
        required: true
        type: choice
        default: 'current'
        options:
          - current
          - all
          - specific
      term:
        description: 'Term code (only used when mode is "specific", e.g., 202502 for Spring 2025)'
        required: false
        default: ''

jobs:
  crawl:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install tsx
        run: npm install -g tsx

      - name: Ensure data directory exists
        run: mkdir -p data

      - name: Save current catalog state
        run: |
          if [ -f data/catalog.json ]; then
            cp data/catalog.json /tmp/catalog-before.json
          else
            echo '{"courses":{}}' > /tmp/catalog-before.json
          fi

      - name: Run crawler
        run: |
          MODE="${{ github.event.inputs.mode }}"
          TERM="${{ github.event.inputs.term }}"

          if [ "$MODE" = "all" ]; then
            echo "Fetching all terms..."
            npx tsx oscar/crawler.ts --all --output data || true
          elif [ "$MODE" = "specific" ] && [ -n "$TERM" ]; then
            echo "Fetching term: $TERM"
            npx tsx oscar/crawler.ts --term $TERM --output data || true
          else
            # Default: current + upcoming terms
            TERMS=$(node -e "
              const now = new Date();
              const year = now.getFullYear();
              const month = now.getMonth() + 1;

              let current, upcoming;
              if (month >= 1 && month <= 4) {
                current = year + '02';
                upcoming = year + '05';
              } else if (month >= 5 && month <= 7) {
                current = year + '05';
                upcoming = year + '08';
              } else {
                current = year + '08';
                upcoming = (year + 1) + '02';
              }
              console.log(current + ' ' + upcoming);
            ")
            for TERM in $TERMS; do
              echo "Fetching term: $TERM"
              npx tsx oscar/crawler.ts --term $TERM --output data || true
            done
          fi

      - name: Detect new courses
        id: detect-changes
        run: |
          # Compare catalogs and find new courses
          NEW_COURSES=$(node -e "
            const fs = require('fs');

            const before = JSON.parse(fs.readFileSync('/tmp/catalog-before.json', 'utf8'));
            const after = JSON.parse(fs.readFileSync('data/catalog.json', 'utf8'));

            const beforeIds = new Set(Object.keys(before.courses || {}));
            const afterIds = Object.keys(after.courses || {});

            const newCourses = afterIds
              .filter(id => !beforeIds.has(id))
              .map(id => {
                const course = after.courses[id];
                return '- **' + id + '** ' + course.name;
              });

            if (newCourses.length > 0) {
              console.log(newCourses.join('\n'));
            }
          ")

          # Save to file for multi-line handling
          echo "$NEW_COURSES" > /tmp/new-courses.txt

          if [ -n "$NEW_COURSES" ]; then
            echo "has_new_courses=true" >> $GITHUB_OUTPUT
          else
            echo "has_new_courses=false" >> $GITHUB_OUTPUT
          fi

      - name: Create PR if changed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name 'Christian Tran'
          git config user.email 'ctran4347@gmail.com'

          git add data/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            BRANCH_NAME="oscar-update-$(date -u +%Y%m%d-%H%M%S)"
            TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

            git checkout -b "$BRANCH_NAME"
            git commit -m "Update OSCAR data $TIMESTAMP"
            git push -u origin "$BRANCH_NAME"

            NEW_COURSES=$(cat /tmp/new-courses.txt)

            if [ -n "$NEW_COURSES" ]; then
              {
                echo "Automated update of OSCAR course data."
                echo ""
                echo "## New Courses"
                echo "$NEW_COURSES"
                echo ""
                echo "## Changes"
                echo "- Updated course availability data from Georgia Tech's Banner system"
                echo ""
                echo "## Auto-generated"
                echo "This PR was automatically created by the OSCAR crawler GitHub Action."
              } > /tmp/pr-body.md
            else
              {
                echo "Automated update of OSCAR course data."
                echo ""
                echo "## Changes"
                echo "- Updated course availability data from Georgia Tech's Banner system"
                echo "- No new courses detected (availability updates only)"
                echo ""
                echo "## Auto-generated"
                echo "This PR was automatically created by the OSCAR crawler GitHub Action."
              } > /tmp/pr-body.md
            fi

            gh pr create \
              --title "Update OSCAR data $TIMESTAMP" \
              --body-file /tmp/pr-body.md \
              --base main \
              --head "$BRANCH_NAME"
          fi
